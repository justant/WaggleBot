# Dashboard ì„±ëŠ¥ ê°œì„  â€” ì™„ë£Œ ë³´ê³ ì„œ

> **ì‘ì—… ê¸°ê°„**: 2026-02
> **ì›ë³¸ ë¬¸ì„œ**: `arch/8. dashboard_performance_refactor.md` + `arch/9. dashboard_performance_followup.md` (í†µí•© í›„ ì‚­ì œ)
> **ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ë¬¸ì œ ìš”ì•½

ëŒ€ì‹œë³´ë“œê°€ ê·¹ì‹¬í•˜ê²Œ ë²„ë²…ì´ëŠ” í˜„ìƒ ë°œìƒ. íŠ¹íˆ GPU(Ollama) ê°€ë™ ì¤‘ í¸ì§‘ì‹¤ íƒ­ì—ì„œ ì‚¬ìš© ë¶ˆê°€ ìˆ˜ì¤€.

**í™˜ê²½**: i9-12900K (24t) / 16GB RAM (WSL2) / RTX 3080 Ti 12GB / qwen2.5:7b

---

## ê·¼ë³¸ ì›ì¸ 5ê°€ì§€

| # | ì›ì¸ | ì‹¬ê°ë„ | ì˜í–¥ |
|---|------|--------|------|
| 1 | 7ê°œ íƒ­ì´ ëª¨ë“  ìƒí˜¸ì‘ìš©ë§ˆë‹¤ ì „ì²´ ì¬ë Œë”ë§ | ğŸ”´ Critical | í•œ íƒ­ í´ë¦­ â†’ 7ê°œ íƒ­ DB ì¿¼ë¦¬+ë Œë” |
| 2 | Gallery `run_every="3s"` per item Ã— 12ê°œ = ì´ˆë‹¹ 4íšŒ DB ì¿¼ë¦¬ | ğŸ”´ Critical | ìƒì‹œ DB ë¶€í•˜ |
| 3 | Editor 30ê°œ ê²Œì‹œê¸€ ëŒ“ê¸€ selectinload (N+1) | ğŸŸ  High | ì§„ì… ì‹œ ìˆ˜ë°±ms ì§€ì—° |
| 4 | `load_pipeline_config()` ë§¤ í˜¸ì¶œë§ˆë‹¤ íŒŒì¼ I/O | ğŸŸ¡ Medium | ë°˜ë³µ ë””ìŠ¤í¬ ì ‘ê·¼ |
| 5 | Image slider HTTP 8ì´ˆ timeout Ã— 30ì¥ ì´ë¯¸ì§€ | ğŸŸ  High | ê²Œì‹œê¸€ ì „í™˜ ìˆ˜ì´ˆ ë¸”ë¡œí‚¹ |

---

## ë³€ê²½ëœ íŒŒì¼ ëª©ë¡

| íŒŒì¼ | ë³€ê²½ ìœ í˜• |
|------|----------|
| `dashboard/app.py` | ê° íƒ­ `@st.fragment` ë˜í•‘ + `_timed_render()` ì„±ëŠ¥ ë¡œê¹… |
| `dashboard/tabs/editor.py` | `st.rerun(scope="fragment")` ì „í™˜, ì´ë¯¸ì§€ expander, ëŒ“ê¸€ ì„ íƒ ë¡œë“œ |
| `dashboard/tabs/inbox.py` | ë‚™ê´€ì  UI, ë¹„ë™ê¸° ìŠ¹ì¸/ê±°ì ˆ, ëŒ“ê¸€ ì¼ê´„ ì‚¬ì „ ë¡œë“œ, `st.rerun(scope="fragment")` |
| `dashboard/tabs/gallery.py` | `run_every="3s"` ì œê±°, ë¹„ë™ê¸° ì—…ë¡œë“œ, í˜ì´ì§€ë„¤ì´ì…˜, `st.rerun(scope="fragment")` |
| `dashboard/tabs/analytics.py` | AI ì¸ì‚¬ì´íŠ¸/í”¼ë“œë°± ë¹„ë™ê¸°í™”, `st.rerun(scope="fragment")` |
| `dashboard/tabs/progress.py` | PROCESSING ë©ˆì¶¤ ê°ì§€, ì¬ì‹œë„ ë¹„ë™ê¸°í™”, `st.rerun(scope="fragment")` |
| `dashboard/tabs/settings.py` | `st.rerun(scope="fragment")` (ê¸°ë³¸ê°’ ë³µì›ë§Œ full rerun ìœ ì§€) |
| `dashboard/tabs/llm_log.py` | `st.rerun(scope="fragment")` |
| `dashboard/components/image_slider.py` | `@st.fragment` ë˜í•‘, timeout 8sâ†’3s |
| `dashboard/components/status_utils.py` | `batch_update_status()` ì¶”ê°€, Ollama í—¬ìŠ¤ì²´í¬ 30ì´ˆ ìºì‹± |
| `dashboard/workers/ai_analysis_tasks.py` | ì‹ ê·œ â€” AI ì í•©ë„ ë¶„ì„ ë°±ê·¸ë¼ìš´ë“œ ì›Œì»¤ |
| `config/settings.py` | `load_pipeline_config()` 5ì´ˆ TTL ìºì‹œ |
| `db/models.py` | Post/Comment ë³µí•© ì¸ë±ìŠ¤ 5ê°œ ì¶”ê°€ |
| `db/session.py` | ì»¤ë„¥ì…˜ í’€ íŠœë‹ (pool_size=10, expire_on_commit=False) |
| `ai_worker/llm/client.py` | requests ì¬ì‹œë„ + timeout ì„¤ì • |

---

## êµ¬í˜„ ìƒì„¸

### 1. `@st.fragment` íƒ­ ê²©ë¦¬ (`app.py`)

ëª¨ë“  7ê°œ íƒ­ì„ `@st.fragment`ë¡œ ë˜í•‘. ìœ„ì ¯ ìƒí˜¸ì‘ìš©ì´ í•´ë‹¹ íƒ­ë§Œ ì¬ì‹¤í–‰.

```python
@st.fragment
def _tab_editor():
    _timed_render("editor", editor.render)
# ... 7ê°œ íƒ­ ë™ì¼ ì ìš©
```

`_timed_render()`: 200ms ì´ìƒ ì†Œìš” ì‹œ WARNING ë¡œê·¸ ì¶œë ¥.

### 2. `st.rerun(scope="fragment")` ì „ë©´ ì ìš©

**ì „ì²´ ëŒ€ì‹œë³´ë“œ 35ê±´** `st.rerun()` â†’ `st.rerun(scope="fragment")` ë³€ê²½.

Full `st.rerun()` ìœ ì§€ (5ê±´ë§Œ):
- `settings.py:338` â€” `_settings_reset_pending` í”Œë˜ê·¸ê°€ `app.py` ìµœìƒìœ„ì—ì„œ ì²˜ë¦¬
- `analytics.py:366,440` â€” sub-fragment(poller) â†’ ë¶€ëª¨ fragment ì „íŒŒ
- `editor.py:685,695` â€” `_task_status_monitor` sub-fragment â†’ ë¶€ëª¨ editor ì „íŒŒ

### 3. í¸ì§‘ì‹¤ (editor.py) ê°œì„ 

| í•­ëª© | Before | After |
|------|--------|-------|
| ëŒ“ê¸€ ë¡œë“œ | 30ê°œ ê²Œì‹œê¸€ ì „ì²´ selectinload | ì„ íƒëœ 1ê°œë§Œ ë³„ë„ ì¿¼ë¦¬ |
| ê²Œì‹œê¸€ ì „í™˜ | Full page rerun + ì´ë¯¸ì§€ HTTP fetch | Fragment rerun, ì´ë¯¸ì§€ collapsed |
| ìë™ìƒì„± ë²„íŠ¼ | ë™ê¸° DB ì—…ë°ì´íŠ¸ â†’ í™”ë©´ lock | ë°±ê·¸ë¼ìš´ë“œ Thread + ë‚™ê´€ì  UI |
| LLM/TTS í´ë§ | `time.sleep(1.5)` + `st.rerun()` | `@st.fragment(run_every="2s")` |
| í˜ì´ì§€ë„¤ì´ì…˜ | ì „ì²´ ë¡œë“œ | 30ê±´ ë‹¨ìœ„ offset/limit |

### 4. ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” (image_slider.py)

- `render_image_slider`ë¥¼ `@st.fragment`ë¡œ ë˜í•‘ â†’ ì´ë¯¸ì§€ â—€/â–¶ ì‹œ ìŠ¬ë¼ì´ë”ë§Œ ì¬ì‹¤í–‰
- HTTP timeout 8s â†’ 3s
- editor.pyì—ì„œ `st.expander("ğŸ“· ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°", expanded=False)`ë¡œ ë˜í•‘ â†’ ê²Œì‹œê¸€ ì „í™˜ ì‹œ fetch ì•ˆ í•¨

### 5. ìˆ˜ì‹ í•¨ (inbox.py) ê°œì„ 

- ë‚™ê´€ì  UI: `hidden_post_ids` + ë°±ê·¸ë¼ìš´ë“œ Threadë¡œ ì¦‰ì‹œ ì¹´ë“œ ì œê±°
- ëŒ“ê¸€ N+1 â†’ ì¼ê´„ ì‚¬ì „ ë¡œë“œ (`_all_comments` dict)
- AI ì í•©ë„ ë¶„ì„: ë™ê¸° LLM í˜¸ì¶œ â†’ `ai_analysis_tasks.py` ë°±ê·¸ë¼ìš´ë“œ ì›Œì»¤
- ì¼ê´„ ìŠ¹ì¸/ê±°ì ˆ: ê°œë³„ `update_status()` ë£¨í”„ â†’ `batch_update_status()` ë‹¨ì¼ SQL

### 6. ê°¤ëŸ¬ë¦¬ (gallery.py) ê°œì„ 

- `run_every="3s"` ì œê±° (ì´ˆë‹¹ 4íšŒ DB ì¿¼ë¦¬ ì›ì¸)
- ì—…ë¡œë“œ ë²„íŠ¼ ë¹„ë™ê¸°í™” (`_upload_tasks` ë ˆì§€ìŠ¤íŠ¸ë¦¬ + Thread)
- í˜ì´ì§€ë„¤ì´ì…˜ 12ê±´ ë‹¨ìœ„

### 7. ë¶„ì„ (analytics.py) ë¹„ë™ê¸°í™”

- AI ì¸ì‚¬ì´íŠ¸ ìƒì„±: `_insight_tasks` + `@st.fragment(run_every="2s")` poller
- í”¼ë“œë°± ë°˜ì˜: `_feedback_task` + `@st.fragment(run_every="2s")` poller

### 8. ë°±ì—”ë“œ ì„±ëŠ¥

- **DB ì¸ë±ìŠ¤**: `ix_post_status_score`, `ix_post_status_created`, `ix_post_status`, `ix_post_site_status`, `ix_post_updated_at`, `ix_comment_post_likes`
- **ì»¤ë„¥ì…˜ í’€**: pool_size=10, max_overflow=20, pool_pre_ping=True, expire_on_commit=False
- **LLM í´ë¼ì´ì–¸íŠ¸**: requests Session ì¬ì‚¬ìš© + Retry(2íšŒ) + timeout(10s connect, 120s read)
- **Ollama í—¬ìŠ¤ì²´í¬**: 30ì´ˆ ì¸ë©”ëª¨ë¦¬ ìºì‹±
- **ì„¤ì • ë¡œë“œ**: 5ì´ˆ TTL ìºì‹œ (`_pipeline_config_cache`)

---

## ì„±ëŠ¥ ê°œì„  ê²°ê³¼

| í•­ëª© | Before | After |
|------|--------|-------|
| íƒ­ í´ë¦­ ì‘ë‹µ | 7ê°œ íƒ­ ì „ì²´ ì¬ë Œë”ë§ | í•´ë‹¹ íƒ­ë§Œ ì¬ì‹¤í–‰ |
| ìˆ˜ì‹ í•¨ ìŠ¹ì¸ | ~500ms (ë™ê¸° DB) | <50ms (ë‚™ê´€ì  UI) |
| 50ê±´ ì¼ê´„ ìŠ¹ì¸ | ~5ì´ˆ (Në²ˆ UPDATE) | <200ms (ë°°ì¹˜ UPDATE) |
| ëŒ“ê¸€ ë¡œë“œ | N+1 ì¿¼ë¦¬ | 1+1 ì¿¼ë¦¬ (ì‚¬ì „ ë¡œë“œ) |
| í¸ì§‘ì‹¤ ê²Œì‹œê¸€ ì „í™˜ | ìˆ˜ì´ˆ (ì´ë¯¸ì§€ HTTP fetch) | <100ms (expander collapsed) |
| ìë™ìƒì„± í™”ë©´ lock | LLM ì‘ë‹µê¹Œì§€ freeze | ì¦‰ì‹œ ë‹¤ìŒ ê²Œì‹œê¸€ ì´ë™ |
| Gallery DB í´ë§ | ì´ˆë‹¹ 4íšŒ ìƒì‹œ | 0íšŒ (ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨) |
| Analytics ì¸ì‚¬ì´íŠ¸ | íƒ­ ì „ì²´ freeze | ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬ |
| ì„¤ì • íŒŒì¼ I/O | ë§¤ í˜¸ì¶œ ë””ìŠ¤í¬ | 5ì´ˆ ìºì‹± |

---

## Full rerun ì •ì±…

`st.rerun()` (full page rerun)ì€ ë‹¤ìŒ ê²½ìš°ì—ë§Œ ì‚¬ìš©:

1. **Settings ê¸°ë³¸ê°’ ë³µì›** â€” `app.py` ìµœìƒìœ„ì˜ `_settings_reset_pending` ì²˜ë¦¬ í•„ìš”
2. **Sub-fragment â†’ ë¶€ëª¨ ì „íŒŒ** â€” `@st.fragment(run_every="2s")` pollerê°€ ì™„ë£Œ ê°ì§€ ì‹œ ë¶€ëª¨ fragment ê°±ì‹  í•„ìš”
   - `editor.py` `_task_status_monitor` (LLM/TTS ì™„ë£Œ)
   - `analytics.py` `_insight_poller` / `_fb_poller` (ì¸ì‚¬ì´íŠ¸/í”¼ë“œë°± ì™„ë£Œ)

ê·¸ ì™¸ ëª¨ë“  ê²½ìš°: `st.rerun(scope="fragment")` ì‚¬ìš©.
