# Fish Speech 1.5 TTS êµì²´ â€” ì „ì²´ êµ¬í˜„ ì™„ë£Œ ê¸°ë¡

> **ìƒíƒœ:** ì™„ë£Œ (Merged to dev)
> **ì»¤ë°‹ ë²”ìœ„:** `1790bf7` ~ `fda4101` (ì´ 9 commits)
> **ê´€ë ¨ íŒŒì¼:** `arch/6. tts_normalize_task.md`, `arch/7. tts_g2pk_hotfix.md` â†’ ì´ íŒŒì¼ì— í†µí•© í›„ ì‚­ì œ

---

## 1. ê²°ì • ì‚¬í•­ (ë³€ê²½ ë¶ˆê°€)

### ëª¨ë¸: S1 (4B) + FP16 ê°•ì œ
- `fishaudio/fish-speech:v1.5.1` ê³ ì • ë²„ì „ ì‚¬ìš© (`latest` ê¸ˆì§€ â€” ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ ê²½ë¡œ ë‹¬ë¼ì§)
- `--half` ì˜µì…˜ ê¸°ë³¸ í™œì„±í™” â†’ RTX 3080 Ti 12GB VRAM ì•ˆì • ìš´ì˜
- OOM ë°œìƒ ì‹œ ìë™ fallback ì—†ìŒ â€” ì‹¤íŒ¨ ì”¬ë§Œ `audio=None` skip í›„ ê³„ì† ì§„í–‰

### ì‹¤í–‰ ë°©ì‹: HTTP JSON API (Docker ì»¨í…Œì´ë„ˆ)
- `fish-speech` ì»¨í…Œì´ë„ˆê°€ `0.0.0.0:8080` ì„œë¹™
- `ai_worker`ê°€ `http://fish-speech:8080/v1/tts`ë¡œ HTTP POST
- ì°¸ì¡° ì˜¤ë””ì˜¤ëŠ” **base64 ì¸ì½”ë”©**ìœ¼ë¡œ JSON bodyì— í¬í•¨ (multipart ì•„ë‹˜)

### ì°¸ì¡° ì˜¤ë””ì˜¤: Zero-shot í´ë¡œë‹
- `assets/voices/korean_man_default.wav` (10~30ì´ˆ, ê¹¨ë—í•œ ë‚¨ì„± ë‚´ë ˆì´í„°)
- `VOICE_PRESETS` dict êµ¬ì¡°ë¡œ ê´€ë¦¬ â†’ í–¥í›„ ìºë¦­í„°ë³„ ì¶”ê°€ ê°€ëŠ¥
- **ì°¸ì¡° í…ìŠ¤íŠ¸(`VOICE_REFERENCE_TEXTS`)** í•„ìˆ˜ â€” ì—†ìœ¼ë©´ í´ë¡œë‹ í’ˆì§ˆ ì €í•˜

### ê°ì • íƒœê·¸ (Fish Speech Control Tags)
| ì”¬ íƒ€ì… | íƒœê·¸ | ì„¤ëª… |
|---------|------|------|
| `intro` | `(excited)` | í›„í‚¹, ì²« 3ì´ˆ ì—ë„ˆì§€ |
| `img_text` | `` (ì—†ìŒ) | ìì—°ì²´ ë‚´ë ˆì´ì…˜ |
| `text_only` | `` (ì—†ìŒ) | ìì—°ì²´ ë‚´ë ˆì´ì…˜ |
| `outro` | `(friendly)` | ë§ˆë¬´ë¦¬, ì¹œê·¼í•œ í†¤ |

### ê¸°ì¡´ TTS ì²˜ë¦¬
- Edge-TTS, Kokoro â†’ `ai_worker/tts/` í´ë” ìœ ì§€ (ì½”ë“œ ì‚­ì œ ì•ˆ í•¨)
- `ai_worker/tts/__init__.py`ì˜ `TTS_ENGINES` dictëŠ” ë ˆê±°ì‹œ í˜¸í™˜ìš©ìœ¼ë¡œ ë‚¨ê¹€
- ì‹ ê·œ íŒŒì´í”„ë¼ì¸ì€ `tts_worker.py`ë¥¼ ì§ì ‘ ì‚¬ìš© (get_tts_engine ê²½ìœ  ì•ˆ í•¨)

---

## 2. êµ¬í˜„ íŒŒì¼ í˜„í™©

### 2-1. docker-compose.yml â€” fish-speech ì„œë¹„ìŠ¤

```yaml
fish-speech:
  image: fishaudio/fish-speech:v1.5.1   # ë²„ì „ ê³ ì • (latest ì‚¬ìš© ê¸ˆì§€)
  container_name: fish-speech
  restart: unless-stopped
  runtime: nvidia
  ports:
    - "8080:8080"
  volumes:
    - ./assets/voices:/opt/fish-speech/references
    - ./checkpoints:/opt/fish-speech/checkpoints
  environment:
    - NVIDIA_VISIBLE_DEVICES=all
    - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    - CUDA_VISIBLE_DEVICES=0
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: 1
            capabilities: [gpu]
  working_dir: /opt/fish-speech
  entrypoint:
    - /bin/bash
    - -c
    - >-
      python tools/api_server.py
      --listen 0.0.0.0:8080
      --llama-checkpoint-path checkpoints/fish-speech-1.5
      --decoder-checkpoint-path checkpoints/fish-speech-1.5/firefly-gan-vq-fsq-8x1024-21hz-generator.pth
      --decoder-config-name firefly_gan_vq
      --half
  healthcheck:
    test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/').read()"]
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 90s   # ëª¨ë¸ ë¡œë“œ ì‹œê°„ ê³ ë ¤
```

**í•µì‹¬ í¬ì¸íŠ¸:**
- `v1.5.1` ì´ë¯¸ì§€ ë‚´ë¶€ ì„¤ì¹˜ ê²½ë¡œ: `/opt/fish-speech/`
- `common.sh` ì—†ìŒ â†’ `python tools/api_server.py` ì§ì ‘ ì‹¤í–‰
- healthcheck: `/health` ì—”ë“œí¬ì¸íŠ¸ ì—†ìŒ â†’ root `/` 200 ì‘ë‹µìœ¼ë¡œ í™•ì¸
- `ai_worker`ì˜ `depends_on.fish-speech: condition: service_healthy`

### 2-2. docker-compose.galaxybook.yml â€” fish-speech ì œì™¸

```yaml
# ê°¤ëŸ­ì‹œë¶ íŒŒì¼ì—ëŠ” fish-speech ì„œë¹„ìŠ¤ ì—†ìŒ
# ai_workerì˜ FISH_SPEECH_URL ë¯¸ì„¤ì • ì‹œ TTS ì‹¤íŒ¨ â†’ ì”¬ë³„ audio=None, ë¬´ìŒ ì²˜ë¦¬
```

galaxybook í™˜ê²½ì—ì„œëŠ” `FISH_SPEECH_URL` í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ìœ¼ë¯€ë¡œ
`tts_worker.synthesize()`ê°€ ì—°ê²° ì‹¤íŒ¨ â†’ `content_processor`ê°€ í•´ë‹¹ ì”¬ `audio=None`ìœ¼ë¡œ ì²˜ë¦¬.

### 2-3. config/settings.py â€” TTS ìƒìˆ˜

```python
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# TTS â€” Fish Speech 1.5
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FISH_SPEECH_URL     = os.getenv("FISH_SPEECH_URL", "http://fish-speech:8080")
FISH_SPEECH_TIMEOUT = 60  # seconds

VOICE_PRESETS: dict[str, str] = {
    "default": "korean_man_default.wav",
}
VOICE_DEFAULT = "default"

# ì°¸ì¡° í…ìŠ¤íŠ¸: zero-shot í´ë¡œë‹ í’ˆì§ˆ í–¥ìƒì— í•„ìˆ˜
VOICE_REFERENCE_TEXTS: dict[str, str] = {
    "default": "ì•ˆë…•í•˜ì„¸ìš”. ì˜¤ëŠ˜ë„ ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.",
}

EMOTION_TAGS: dict[str, str] = {
    "intro":     "(excited)",
    "img_text":  "",
    "text_only": "",
    "outro":     "(friendly)",
}

TTS_OUTPUT_FORMAT = "wav"
TTS_SAMPLE_RATE   = 44100
```

### 2-4. ai_worker/tts_worker.py â€” Fish Speech í´ë¼ì´ì–¸íŠ¸

```python
"""Fish Speech 1.5 TTS í´ë¼ì´ì–¸íŠ¸."""
import asyncio
import base64
import logging
from pathlib import Path

import httpx

from config.settings import (
    EMOTION_TAGS, FISH_SPEECH_TIMEOUT, FISH_SPEECH_URL,
    TTS_OUTPUT_FORMAT, VOICE_DEFAULT, VOICE_PRESETS, VOICE_REFERENCE_TEXTS,
)

logger = logging.getLogger(__name__)
VOICES_DIR = Path(__file__).parent.parent / "assets" / "voices"


async def synthesize(
    text: str,
    scene_type: str = "img_text",
    voice_key: str = VOICE_DEFAULT,
    output_path: Path | None = None,
) -> Path:
    emotion   = EMOTION_TAGS.get(scene_type, "")
    final_text = f"{emotion} {text}".strip() if emotion else text

    ref_filename = VOICE_PRESETS.get(voice_key, VOICE_PRESETS[VOICE_DEFAULT])
    ref_audio    = VOICES_DIR / ref_filename

    if output_path is None:
        output_path = Path(f"/tmp/tts_{abs(hash(final_text))}.{TTS_OUTPUT_FORMAT}")

    # ì°¸ì¡° ì˜¤ë””ì˜¤: base64 ì¸ì½”ë”© í›„ JSON bodyì— í¬í•¨ (multipart ì•„ë‹˜)
    if ref_audio.exists():
        ref_text  = VOICE_REFERENCE_TEXTS.get(voice_key, VOICE_REFERENCE_TEXTS.get(VOICE_DEFAULT, ""))
        audio_b64 = base64.b64encode(ref_audio.read_bytes()).decode()
        references = [{"audio": audio_b64, "text": ref_text}]
    else:
        logger.warning("ì°¸ì¡° ì˜¤ë””ì˜¤ ì—†ìŒ â†’ ê¸°ë³¸ ìŒì„±ìœ¼ë¡œ í´ë°±: %s", ref_audio)
        references = []

    async with httpx.AsyncClient(timeout=FISH_SPEECH_TIMEOUT) as client:
        resp = await client.post(
            f"{FISH_SPEECH_URL}/v1/tts",
            json={
                "text":       final_text,
                "format":     TTS_OUTPUT_FORMAT,
                "references": references,
            },
        )
        resp.raise_for_status()
        output_path.write_bytes(resp.content)

    logger.info("TTS ìƒì„±: scene=%s %dì â†’ %s (%dKB)",
                scene_type, len(text), output_path.name, len(resp.content)//1024)
    return output_path


async def wait_for_fish_speech(retries: int = 10, delay: float = 5.0) -> bool:
    """Fish Speech ì„œë²„ ê¸°ë™ ëŒ€ê¸°."""
    async with httpx.AsyncClient(timeout=5) as client:
        for i in range(retries):
            try:
                r = await client.get(f"{FISH_SPEECH_URL}/")  # /health ì—†ìŒ, rootë¡œ í™•ì¸
                if r.status_code < 400:
                    logger.info("Fish Speech ì„œë²„ ì¤€ë¹„ ì™„ë£Œ (%s)", FISH_SPEECH_URL)
                    return True
            except httpx.ConnectError:
                logger.warning("Fish Speech ëŒ€ê¸° ì¤‘ (%d/%d)", i+1, retries)
            await asyncio.sleep(delay)
    logger.error("Fish Speech ì„œë²„ ì—°ê²° ì‹¤íŒ¨: %s", FISH_SPEECH_URL)
    return False
```

---

## 3. í•œêµ­ì–´ í…ìŠ¤íŠ¸ ì •ê·œí™” (tts_normalize_task í†µí•©)

Fish SpeechëŠ” ì˜ì–´ ì¤‘ì‹¬ìœ¼ë¡œ í•™ìŠµë˜ì–´ **í•œêµ­ì–´ íŠ¹ìˆ˜ íŒ¨í„´ ì²˜ë¦¬**ê°€ í•„ìš”.

### ì²˜ë¦¬ ëŒ€ìƒ
| íŒ¨í„´ | ì˜ˆì‹œ | ì²˜ë¦¬ ë°©ë²• |
|------|------|-----------|
| ìˆ«ì | `3ë§Œì›`, `2024ë…„` | í•œêµ­ì–´ ì½ê¸° ë³€í™˜ |
| ì˜ë¬¸ ì•½ì–´ | `LLM`, `API`, `TTS` | ê·¸ëŒ€ë¡œ ë‘ê±°ë‚˜ í’€ì–´ì“°ê¸° |
| íŠ¹ìˆ˜ë¬¸ì | `~`, `ã…‹ã…‹`, `...` | ì½ê¸° ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜ |
| ì´ëª¨ì§€ | `ğŸ˜‚`, `ğŸ”¥` | ì œê±° |

### ì •ê·œí™” í•¨ìˆ˜ ìœ„ì¹˜: `ai_worker/tts_worker.py`

```python
import re

def normalize_korean_for_tts(text: str) -> str:
    """Fish Speech TTS ì „ì²˜ë¦¬: í•œêµ­ì–´ ì½ê¸° ì •ê·œí™”."""
    # ì´ëª¨ì§€ ì œê±°
    text = re.sub(r'[^\w\s\.,!?~ã„±-ã…ê°€-í£a-zA-Z0-9()"\']', '', text)
    # ê³¼ë„í•œ ë°˜ë³µ ì¶•ì•½ (ã…‹ã…‹ã…‹ã…‹ â†’ ã…‹ã…‹)
    text = re.sub(r'(ã…‹|ã…|ã… |ã…œ){3,}', r'\1\1', text)
    # ë§ì¤„ì„í‘œ í†µì¼
    text = re.sub(r'\.{2,}', 'â€¦', text)
    # ë¬¼ê²°í‘œ ì œê±° (TTSì—ì„œ ì´ìƒí•˜ê²Œ ì½í˜)
    text = text.replace('~', '')
    return text.strip()
```

`synthesize()` í•¨ìˆ˜ ë‚´ì—ì„œ `final_text`ì— ì ìš©:
```python
final_text = normalize_korean_for_tts(
    f"{emotion} {text}".strip() if emotion else text
)
```

---

## 4. g2pk í•œêµ­ì–´ ë°œìŒ ë³€í™˜ (tts_g2pk_hotfix í†µí•©)

### ë¬¸ì œ
Fish Speechê°€ í•œêµ­ì–´ ì—°ìŒ/ê²½ìŒí™”/ë°›ì¹¨ ë³€í™”ë¥¼ ì¼ë¶€ ì˜ëª» ì½ëŠ” í˜„ìƒ.
ì˜ˆ: `êµ­ë¬¼` â†’ [ê¶ë¬¼] ë¡œ ì½ì–´ì•¼ í•˜ëŠ”ë° [êµ­ë¬¼] ë¡œ ì½ìŒ.

### í•´ê²°: g2pk ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì„ íƒì  ì ìš©)

```python
# requirements.txtì— ì¶”ê°€ (ì„ íƒ â€” ì—†ì–´ë„ ë™ì‘)
# g2pk>=0.9.4
```

```python
# ai_worker/tts_worker.py ìƒë‹¨
try:
    from g2pk import G2p
    _g2p = G2p()
    G2PK_AVAILABLE = True
except ImportError:
    _g2p = None
    G2PK_AVAILABLE = False
    logger.info("g2pk ì—†ìŒ â€” ë°œìŒ ë³€í™˜ ì—†ì´ ì§„í–‰ (ì„ íƒ ì‚¬í•­)")

def apply_g2pk(text: str) -> str:
    """g2pk ë°œìŒ ë³€í™˜ (ì„¤ì¹˜ëœ ê²½ìš°ì—ë§Œ ì ìš©)."""
    if not G2PK_AVAILABLE or _g2p is None:
        return text
    try:
        return _g2p(text)
    except Exception as e:
        logger.debug("g2pk ë³€í™˜ ì‹¤íŒ¨ â€” ì›ë¬¸ ì‚¬ìš©: %s", e)
        return text
```

`normalize_korean_for_tts()` ì´í›„, `synthesize()` ë‚´ì—ì„œ ì ìš©:
```python
final_text = apply_g2pk(normalize_korean_for_tts(...))
```

### g2pk ì„¤ì¹˜ (GPU í™˜ê²½ë§Œ ê¶Œì¥)
```bash
pip install g2pk
# ì˜ì¡´ì„±: konlpy, java í•„ìš”
```
> galaxybook(No-GPU) í™˜ê²½ì—ì„œëŠ” g2pk ì„¤ì¹˜ ìƒëµ ê°€ëŠ¥. ë¯¸ì„¤ì¹˜ ì‹œ ìë™ skip.

---

## 5. ì°¸ì¡° ì˜¤ë””ì˜¤ ì¤€ë¹„ ê°€ì´ë“œ

```
assets/voices/
â”œâ”€â”€ README.md
â””â”€â”€ korean_man_default.wav    â† ì§ì ‘ ì¤€ë¹„ í•„ìš” (ì»¤ë°‹ ê¸ˆì§€)
```

### ìš”êµ¬ ì‚¬í•­
- í¬ë§·: WAV, **16kHz ì´ìƒ**, ëª¨ë…¸ ê¶Œì¥
- ê¸¸ì´: **10~30ì´ˆ** (ì§§ìœ¼ë©´ í’ˆì§ˆ ì €í•˜)
- ë‚´ìš©: ì¡ìŒ ì—†ëŠ” ê¹¨ë—í•œ ëª©ì†Œë¦¬ (ë‚˜ë ˆì´ì…˜ í†¤)

### VOICE_REFERENCE_TEXTS ë“±ë¡
ì°¸ì¡° ì˜¤ë””ì˜¤ WAV íŒŒì¼ì—ì„œ ì‹¤ì œë¡œ ë§í•œ ë‚´ìš©ì„ `settings.py`ì— ë“±ë¡:
```python
VOICE_REFERENCE_TEXTS = {
    "default": "ì—¬ê¸°ì„œ ì‹¤ì œë¡œ ë§í•œ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì…ë ¥í•˜ì„¸ìš”.",
}
```
> í…ìŠ¤íŠ¸ê°€ ì‹¤ì œ ìŒì„±ê³¼ ì¼ì¹˜í• ìˆ˜ë¡ í´ë¡œë‹ í’ˆì§ˆ í–¥ìƒ.

---

## 6. ëª¨ë¸ ë‹¤ìš´ë¡œë“œ

```bash
#!/bin/bash
# scripts/download_fish_speech.sh
huggingface-cli download fishaudio/fish-speech-1.5 \
  --local-dir ./checkpoints/fish-speech-1.5
echo "ì™„ë£Œ. ê²½ë¡œ: ./checkpoints/fish-speech-1.5"
```

í•„ìš” íŒŒì¼ í™•ì¸:
```
checkpoints/fish-speech-1.5/
â”œâ”€â”€ model.pth                          â† LLaMA ëª¨ë¸
â”œâ”€â”€ firefly-gan-vq-fsq-8x1024-21hz-generator.pth  â† Decoder
â””â”€â”€ (ê¸°íƒ€ config íŒŒì¼)
```

---

## 7. ai_worker/main.py â€” ì‹œì‘ ì‹œ í—¬ìŠ¤ì²´í¬

```python
async def _startup() -> None:
    from ai_worker.tts_worker import wait_for_fish_speech
    ready = await wait_for_fish_speech(retries=10, delay=5.0)
    if not ready:
        logger.warning("Fish Speech ì„œë²„ ë¯¸ì¤€ë¹„ â€” TTS ì‹¤íŒ¨ ì‹œ í•´ë‹¹ ì”¬ë§Œ ë¬´ìŒ ì²˜ë¦¬")

def main() -> None:
    ...
    asyncio.run(_startup())
    asyncio.run(_main_loop())
```

---

## 8. ì™„ë£Œ ê¸°ì¤€ (Definition of Done)

- [x] `docker compose up fish-speech` í›„ root `/` 200 ì‘ë‹µ
- [x] `test/test_tts.py` ì‹¤í–‰ ì‹œ wav íŒŒì¼ ìƒì„±
- [x] `(excited)` íƒœê·¸ê°€ intro ì”¬ í…ìŠ¤íŠ¸ì— prefix ì ìš©
- [x] OOM/ì—°ê²° ì‹¤íŒ¨ ì‹œ í•´ë‹¹ ì”¬ `audio=None`ìœ¼ë¡œ skip, íŒŒì´í”„ë¼ì¸ ê³„ì† ì§„í–‰
- [x] galaxybook í™˜ê²½ì—ì„œ fish-speech ì—†ì´ë„ íŒŒì´í”„ë¼ì¸ ì •ìƒ ë™ì‘ (ë¬´ìŒ)
- [x] í•œêµ­ì–´ ì´ëª¨ì§€/íŠ¹ìˆ˜ë¬¸ì ì •ê·œí™” ì ìš©
- [x] g2pk ë¯¸ì„¤ì¹˜ ì‹œ ìë™ skip (ImportError ë¬´ì‹œ)

---

## 9. í…ŒìŠ¤íŠ¸

```bash
# Fish Speech ë‹¨ë… í…ŒìŠ¤íŠ¸
python test/test_tts.py

# ì „ì²´ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸
docker compose logs --tail 50 fish-speech
docker compose logs --tail 50 ai_worker
```

```python
# test/test_tts.py
"""Fish Speech TTS ë‹¨ë… í…ŒìŠ¤íŠ¸."""
import asyncio
from ai_worker.tts_worker import synthesize, wait_for_fish_speech

async def main():
    ready = await wait_for_fish_speech(retries=3, delay=2.0)
    if not ready:
        print("Fish Speech ì„œë²„ ë¯¸ì¤€ë¹„")
        return

    for scene in ["intro", "img_text", "text_only", "outro"]:
        path = await synthesize(
            text="ì•ˆë…•í•˜ì„¸ìš”, Fish Speech í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.",
            scene_type=scene,
        )
        print(f"[{scene}] ìƒì„± ì™„ë£Œ: {path}")

asyncio.run(main())
```
