# WaggleBot ë¦¬íŒ©í† ë§ ì™„ë£Œ ë³´ê³ ì„œ

> **ì»¤ë°‹**: `aa533e8` â†’ `fb7be57` â†’ `b107b33`
> **ëŒ€ìƒ ì§€ì‹œì„œ**: `refactor_instructions.md` (Phase 1), `refactor_phase2_instructions.md` (Phase 2), `dashboard_improvements.md` (Dashboard)
> **ì™„ë£Œì¼**: 2026-02-21

---

## Phase 1: êµ¬ì¡° ê°œì„  (Task 1~5)

### Task 1: Dead Code ì‚­ì œ
- `crawlers/configurable_crawler.py` â€” YAML ê¸°ë°˜ ë²”ìš© í¬ë¡¤ëŸ¬ (ì‚¬ìš© ì•ˆ ë¨) ì‚­ì œ
- `crawlers/site_loader.py` â€” ì‚¬ì´íŠ¸ ì„¤ì • ë¡œë” ì‚­ì œ
- `config/sites.yaml` â€” YAML ì‚¬ì´íŠ¸ ì„¤ì • ì‚­ì œ
- `crawlers/nate_tok.py` â€” êµ¬í˜„ ì—†ëŠ” ë¹ˆ í¬ë¡¤ëŸ¬ ì‚­ì œ
- `db/migrations/run_migration.py`, `run_llm_logs_migration.py` â€” ê°œë³„ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‚­ì œ

### Task 2: BaseCrawler ê³µí†µ í—¬í¼ í†µí•©
- `crawlers/base.py`ì— `__init__`, `_rotate_ua()`, `_get()`, `_post()`, `_parse_int()`, `_parse_stat()`, `_text()` ì¶”ê°€
- 4ê°œ í¬ë¡¤ëŸ¬(`nate_pann`, `bobaedream`, `dcinside`, `fmkorea`)ì—ì„œ ì¤‘ë³µ ì½”ë“œ ì œê±° ë° `super().__init__()` í˜¸ì¶œë¡œ ëŒ€ì²´
- `nate_pann.py`ì˜ `_parse_stat` (ë‹¤ë¥¸ ì‹œê·¸ë‹ˆì²˜) â†’ `_text()` + `_parse_int()` ì¡°í•©ìœ¼ë¡œ êµì²´

### Task 3: í¬ë¡¤ëŸ¬ ì„¹ì…˜ ì„¤ì • ë¶„ë¦¬
- `settings.py`ì˜ `NATE_PANN_SECTIONS`, `BOBAEDREAM_SECTIONS`, `DCINSIDE_SECTIONS`, `FMKOREA_SECTIONS` ì‚­ì œ
- ê° í¬ë¡¤ëŸ¬ í´ë˜ìŠ¤ì— `SECTIONS` í´ë˜ìŠ¤ ë³€ìˆ˜ë¡œ ì´ë™
- `for section in self.SECTIONS:` íŒ¨í„´ìœ¼ë¡œ í†µì¼

### Task 4: DB ë§ˆì´ê·¸ë ˆì´ì…˜ ëŸ¬ë„ˆ í†µí•©
- SQL íŒŒì¼ ì •ê·œí™”: `001_images_contents.sql`, `002_add_llm_logs.sql`, `003_add_variant_fields.sql`
- `db/migrations/runner.py` ì‹ ê·œ ìƒì„± â€” `schema_migrations` í…Œì´ë¸”ë¡œ ì ìš© ì´ë ¥ ì¶”ì 
- `db/migrations/__init__.py` ìƒì„±

### Task 5: ê²€ì¦ ì™„ë£Œ
- ëª¨ë“  í¬ë¡¤ëŸ¬ import ì •ìƒ
- BaseCrawler ìƒì† ê²€ì¦ í†µê³¼
- ë§ˆì´ê·¸ë ˆì´ì…˜ ëŸ¬ë„ˆ import ì •ìƒ

---

## Phase 2: í™•ì¥ì„±Â·ì•ˆì •ì„± ê°•í™” (Task 6~12)

### Task 6: Content.get_script() ìˆœí™˜ import ì œê±°
- `ScriptData` dataclassë¥¼ `ai_worker/llm.py` â†’ `db/models.py`ë¡œ ì´ë™
- `ai_worker/llm.py`ì—ì„œ `from db.models import ScriptData` re-export ìœ ì§€ (í˜¸í™˜ì„±)
- `Content.get_script()`ì˜ lazy import ì œê±°

### Task 7: settings.py ë„ë©”ì¸ë³„ ë¶„ë¦¬
- `config/crawler.py` ì‹ ê·œ ìƒì„± â€” `USER_AGENTS`, `REQUEST_HEADERS`, `REQUEST_TIMEOUT`, `ENABLED_CRAWLERS`
- `config/monitoring.py` ì‹ ê·œ ìƒì„± â€” GPU/ë””ìŠ¤í¬/ë©”ëª¨ë¦¬ ì„ê³„ê°’, ì´ë©”ì¼/ìŠ¬ë™ ì•Œë¦¼ ì„¤ì •
- `config/settings.py`ì—ì„œ ì„œë¸Œëª¨ë“ˆ re-export (ê¸°ì¡´ import ê²½ë¡œ í˜¸í™˜ ìœ ì§€)

### Task 8: analytics ëª¨ë“ˆ Ollama ì§ì ‘ í˜¸ì¶œ ì œê±°
- `ai_worker/llm.py`ì— `call_ollama_raw()` ë²”ìš© í•¨ìˆ˜ ì¶”ê°€
- `analytics/feedback.py`ì˜ `requests.post()` ì§ì ‘ í˜¸ì¶œ â†’ `call_ollama_raw()` êµì²´
- ë¶ˆí•„ìš”í•´ì§„ `import requests`, `get_ollama_host`, `OLLAMA_MODEL` import ì œê±°

### Task 9: plugin_manager.py ë‹¨ìˆœí™”
- `CrawlerRegistry.auto_discover()`, `unregister()`, `clear()` ì‚­ì œ (ì‚¬ìš©ì²˜ ì—†ìŒ)
- ëª¨ë“ˆ ë ˆë²¨ `auto_discover()` í•¨ìˆ˜ ì‚­ì œ
- `get_crawler()`, `list_crawlers()` í¸ì˜ í•¨ìˆ˜ ìœ ì§€

### Task 10: arch/ ë¬¸ì„œ ì •ë¦¬
- `arch/done/` ë””ë ‰í† ë¦¬ ìƒì„±
- `arch/1. dev_spec.md`, `arch/2. next_spec_by_claude.md`, `arch/3. renderer_from_figma.md` â†’ `arch/done/` ì´ë™
- ë¯¸ì‹¤í–‰ ìŠ¤í™(`4. llm_optimization.md`, `5. tts_inhancement.md`, `ai_worker_restructure.md`)ì— ìƒíƒœ ë°°ë„ˆ ì¶”ê°€
- `CLAUDE.md`ì— `arch/` ë¬¸ì„œ ê°€ì´ë“œ ì„¹ì…˜ ì¶”ê°€

### Task 11: Uploader í™•ì¥ì„± ê°œì„ 
- `uploaders/base.py`ì— `UploaderRegistry` íŒ¨í„´ ë„ì… (CrawlerRegistryì™€ ë™ì¼ êµ¬ì¡°)
- `uploaders/youtube.py`ì— `@UploaderRegistry.register("youtube")` ì ìš©
- `uploaders/uploader.py`ë¥¼ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ê¸°ë°˜ ë””ìŠ¤íŒ¨ì¹˜ë¡œ êµì²´
- `uploaders/ADDING_UPLOADER.md` ì‹ ê·œ ì‘ì„±

### Task 12: ì—ëŸ¬ ì²˜ë¦¬ ì¼ê´€ì„± í™•ë³´
- `crawlers/base.py`ì— `retry()` ë°ì½”ë ˆì´í„° ì¶”ê°€ (max_attempts=3, exponential backoff)
- `_get()`, `_post()`ì— `@retry` ì ìš©

---

## Dashboard ê°œì„  (D-1~D-20)

### Part A: ë¦¬íŒ©í† ë§ ì •í•©ì„± ìˆ˜ì • (ì»¤ë°‹ aa533e8)

| Task | ë‚´ìš© |
|------|------|
| D-1 | `run_ai_fit_analysis()`, Analytics ì¸ì‚¬ì´íŠ¸ ì„¹ì…˜ì˜ Ollama ì§ì ‘ í˜¸ì¶œ â†’ `call_ollama_raw()` êµì²´ |
| D-2 | `from ai_worker.llm import ScriptData` (ë¶„ì‚°ëœ lazy import 5ê³³) â†’ `from db.models import ScriptData` (íŒŒì¼ ìµœìƒë‹¨ ë‹¨ì¼ import) |
| D-3 | ìˆ˜ì‹ í•¨ ì‚¬ì´íŠ¸ í•„í„° í•˜ë“œì½”ë”© â†’ `list_crawlers().keys()` ë™ì  ì¡°íšŒ |
| D-4 | `upload_post` import ê²½ë¡œ UploaderRegistry ë°˜ì˜ í™•ì¸ |

### Part B: ìš´ì˜ì í¸ì˜ì„± ê°œì„  (ì»¤ë°‹ fb7be57)

| Task | ë‚´ìš© |
|------|------|
| D-5 | ì§„í–‰í˜„í™© íƒ­ ë©”íŠ¸ë¦­ ìë™ ê°±ì‹  (`@st.fragment(run_every="5s")`) |
| D-6 | ìˆ˜ì‹ í•¨ ì „ì²´ ì„ íƒ/í•´ì œ í† ê¸€ ë²„íŠ¼ ì¶”ê°€ |
| D-7 | ê°¤ëŸ¬ë¦¬ ìƒíƒœë³„ í•„í„° (`PREVIEW_RENDERED` / `RENDERED` / `UPLOADED`) |
| D-8 | í¸ì§‘ì‹¤ ëŒ€ë³¸ ì €ì¥ ì „ ìœ íš¨ì„± ê²€ì¦ (hook/body/closer/ìµœì†Œ 15ì´ˆ) |
| D-9 | LLM ì´ë ¥ íƒ­ Post ID ê²€ìƒ‰ í•„í„° ì¶”ê°€ |
| D-10 | ì„¤ì • íƒ­ Ollama ì—°ê²° ìƒíƒœ í™•ì¸ ë²„íŠ¼ |
| D-11 | ê°¤ëŸ¬ë¦¬ ì‚­ì œ í™•ì¸ UX â†’ `st.popover` ê¸°ë°˜ìœ¼ë¡œ ê°œì„  |
| D-12 | ìˆ˜ì‹ í•¨ ì²˜ë¦¬ í˜„í™© progress bar (ì „ì²´ ì²˜ë¦¬ìœ¨ í‘œì‹œ) |

### Part C: ìš´ì˜ ì•ˆì •ì„± ê°œì„  (ì»¤ë°‹ b107b33)

| Task | ë‚´ìš© |
|------|------|
| D-13 | Ollama ì„œë²„ ë‹¤ìš´ ì‹œ 2ì´ˆ í—¬ìŠ¤ì²´í¬ í›„ ë¹ ë¥¸ ì‹¤íŒ¨ (4ê°œ ë²„íŠ¼ì— ì ìš©) |
| D-14 | HD ë Œë” í ì¤‘ë³µ ìš”ì²­ ë°©ì§€ (`_hd_render_pending` ì²´í¬) |
| D-15 | ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ í”Œë«í¼ë³„ ì—ëŸ¬ ìƒì„¸ í‘œì‹œ |
| D-16 | í¸ì§‘ì‹¤ DB ì„¸ì…˜ ë²”ìœ„ ë¶„ë¦¬ (ì½ê¸°/ì“°ê¸° ì„¸ì…˜ ë¶„ë¦¬) |
| D-17 | ì´ë¯¸ì§€ í”„ë¡ì‹œ ìºì‹± (`@st.cache_data(ttl=300)`) |
| D-18 | ìë™ ìŠ¹ì¸ ë™ì‘ í•œê³„ ì•ˆë‚´ (ìˆ˜ì‹ í•¨ íƒ­ ë¡œë“œ ì‹œì—ë§Œ ë™ì‘í•¨ì„ í‘œì‹œ) |
| D-19 | ì„¤ì • íƒ­ TTS ì„ì‹œ íŒŒì¼ ì •ë¦¬ ë²„íŠ¼ |
| D-20 | FAILED ìƒíƒœ ê²Œì‹œê¸€ì— ì—ëŸ¬ ì›ì¸ í‘œì‹œ + ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ |

---

## ë³€ê²½ íŒŒì¼ ìš”ì•½

| íŒŒì¼ | ì‘ì—… |
|------|------|
| `crawlers/base.py` | âœï¸ ê³µí†µ í—¬í¼ + `retry()` ì¶”ê°€ |
| `crawlers/nate_pann.py` | âœï¸ ì¤‘ë³µ ì œê±° + ì„¹ì…˜ ì´ë™ |
| `crawlers/bobaedream.py` | âœï¸ ì¤‘ë³µ ì œê±° + ì„¹ì…˜ ì´ë™ |
| `crawlers/dcinside.py` | âœï¸ ì¤‘ë³µ ì œê±° + ì„¹ì…˜ ì´ë™ |
| `crawlers/fmkorea.py` | âœï¸ ì¤‘ë³µ ì œê±° + ì„¹ì…˜ ì´ë™ |
| `crawlers/plugin_manager.py` | âœï¸ ë¶ˆí•„ìš” ë©”ì„œë“œ ì‚­ì œ |
| `config/settings.py` | âœï¸ ì„¹ì…˜ ìƒìˆ˜ ì œê±° + ì„œë¸Œëª¨ë“ˆ re-export |
| `config/crawler.py` | ğŸ†• í¬ë¡¤ëŸ¬ ê³µí†µ ì„¤ì • |
| `config/monitoring.py` | ğŸ†• ëª¨ë‹ˆí„°ë§ ì„¤ì • |
| `db/models.py` | âœï¸ ScriptData í´ë˜ìŠ¤ ì¶”ê°€ |
| `db/migrations/runner.py` | ğŸ†• í†µí•© ë§ˆì´ê·¸ë ˆì´ì…˜ ëŸ¬ë„ˆ |
| `db/migrations/__init__.py` | ğŸ†• íŒ¨í‚¤ì§€ ì´ˆê¸°í™” |
| `db/migrations/001~003.sql` | ğŸ“¦ ì •ê·œí™” ì´ë™ |
| `ai_worker/llm.py` | âœï¸ ScriptData re-export + `call_ollama_raw()` ì¶”ê°€ |
| `analytics/feedback.py` | âœï¸ Ollama ì§ì ‘ í˜¸ì¶œ â†’ `call_ollama_raw()` |
| `uploaders/base.py` | âœï¸ UploaderRegistry ì¶”ê°€ |
| `uploaders/youtube.py` | âœï¸ `@UploaderRegistry.register` ì ìš© |
| `uploaders/uploader.py` | âœï¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ê¸°ë°˜ ë””ìŠ¤íŒ¨ì¹˜ |
| `uploaders/ADDING_UPLOADER.md` | ğŸ†• ì—…ë¡œë” ì¶”ê°€ ê°€ì´ë“œ |
| `dashboard.py` | âœï¸ D-1~D-20 ì „ì²´ ì ìš© |
| `arch/done/` | ğŸ†• ì™„ë£Œ ë¬¸ì„œ ì´ë™ ë””ë ‰í† ë¦¬ |
| `CLAUDE.md` | âœï¸ arch/ ê°€ì´ë“œ + ëª¨ë“ˆ í˜„í™© ì—…ë°ì´íŠ¸ |
| `crawlers/configurable_crawler.py` | ğŸ—‘ ì‚­ì œ |
| `crawlers/site_loader.py` | ğŸ—‘ ì‚­ì œ |
| `crawlers/nate_tok.py` | ğŸ—‘ ì‚­ì œ |
| `config/sites.yaml` | ğŸ—‘ ì‚­ì œ |
| `db/migrations/run_migration.py` | ğŸ—‘ ì‚­ì œ |
| `db/migrations/run_llm_logs_migration.py` | ğŸ—‘ ì‚­ì œ |
