# 긴급 수정: tts_worker.py g2pk 이중 G2P 문제 해결

## 상황 요약

커밋 `1eb4e99` 적용 후 TTS 출력이 **이전보다 더 심각하게 악화**됨. 음성이 깨지거나, 의미 없는 발음이 나오거나, 일부 문장이 극도로 짧게(0.5초) 합성됨.

---

## 근본 원인: g2pk 이중 G2P (critical)

### 문제 메커니즘

현재 코드의 3단계에서 `g2pk`가 **텍스트 전체**를 **발음형(pronunciation form)**으로 변환한다:

```python
# 현재 코드 (문제)
if _G2PK_AVAILABLE:
    text = _get_g2p()(text)  # ← 전체 텍스트를 발음형으로 변환!
```

g2pk는 한국어 맞춤법 텍스트를 **실제 발음 표기**로 바꾸는 라이브러리다:

| 원본 (맞춤법) | g2pk 출력 (발음형) | 변환 규칙 |
|---|---|---|
| 집안 | 지반 | 연음화 |
| 연애 | 여내 | 연음화 |
| 결혼은 | 겨로는 | 연음화 |
| 댓글 | 댇끌 | 받침 대표음+경음화 |
| 돈독해서 | 돈도캐서 | 경음화+거센소리되기 |
| 듣고 | 듣꼬 | 경음화 |
| 생각은 | 생가근 | 연음화 |

**Fish Speech는 자체 G2P가 내장**되어 있어서 **표준 맞춤법 텍스트**를 입력으로 기대한다. g2pk의 발음형 텍스트를 받으면 Fish Speech가 이를 다시 자체 G2P로 처리하여 **이중 변환**이 발생한다:

```
"집안" → [g2pk] → "지반" → [Fish Speech G2P] → "지반"을 다시 발음 처리 → 깨진 출력
```

"지반"은 "집안(가정)"과 완전히 다른 단어("지반 = 地盤, 땅")이므로 Fish Speech는 의미도 다르고 운율도 다른 음성을 합성한다.

### 실제 입력별 문제 트레이스

| 입력 텍스트 | g2pk 적용 후 Fish Speech에 전달되는 텍스트 |
|---|---|
| 남자친구 집안 때문에 헤어져? | 남자친구 **지반** **때무네** 헤어져? |
| 이십 대 후반 여자 남자친구와 오 년 넘게 연애 중. | **이십때** 후반 여자 남자친구와 오년 넘게 **여내** 중. |
| 명절 방문 이야기 듣고 부모님 반대 당함. | 명절 방문 이야기 **듣꼬** 부모님 반대 당함. |
| 남자친구 가족 관계 너무 돈독해서 걱정됨. | 남자친구 가족 **관게** 너무 **돈도캐서** **걱쩡됨**. |
| 베스트 댓글 올바른 결혼은 효자가 아니라. | 베스트 **댇끌** 올바른 **겨로는** 효자가 아니라. |
| 여러분들의 생각은 어떤가요? | **여러분드리** **생가근** 어떤가요? |

### 오디오 증거

영상 오디오에서 silence detection 분석 결과:

```
Segment 1: 0.51초 ← "남자친구 지반 때무네 헤어져?" — 비정상적으로 짧음 (정상 2초+)
Segment 2: 2.58초
Segment 3: 4.73초
Segment 4: 0.62초 ← 비정상적으로 짧음
Segment 5: 4.93초
```

입력 6개에 대해 오디오 세그먼트가 5개뿐이고, 2개 세그먼트가 비정상적으로 짧다. g2pk 발음형 텍스트를 받은 Fish Speech가 합성에 실패하거나 극도로 짧은 출력을 생성한 것으로 추정.

---

## 수정 사항

### 1. g2pk 전체 텍스트 적용 제거 (critical — 반드시 수정)

`_normalize_for_tts()` 함수의 3단계에서 g2pk 분기를 **완전히 제거**하고, **항상 built-in 숫자 변환**을 사용한다.

**변경 전:**
```python
# 3. 숫자 → 한국어 읽기 변환
if _G2PK_AVAILABLE:
    # g2pk에 위임: 숫자 읽기 + 연음/경음화 발음 규칙 정규화 (to_syl=True 기본값)
    text = _get_g2p()(text)  # type: ignore[operator]
else:
    # 내장 변환: 단위별 수사 선택
    all_counters = "|".join(
        re.escape(c) for c in sorted(_NATIVE_COUNTERS | _SINO_COUNTERS, key=len, reverse=True)
    )
    text = re.sub(rf'(\d+)\s*({all_counters})', _convert_number_with_counter, text)
    text = re.sub(r'(\d+)\s*%', lambda m: _sino_number(int(m.group(1))) + " 퍼센트", text)
    text = re.sub(r'\d+', _convert_standalone_number, text)
```

**변경 후:**
```python
# 3. 숫자 → 한국어 읽기 변환 (built-in만 사용)
# ⚠️ g2pk는 전체 텍스트를 발음형으로 변환하므로 Fish Speech와 이중 G2P 충돌 발생.
#    Fish Speech는 자체 G2P가 있으므로 표준 맞춤법 텍스트를 입력해야 한다.
all_counters = "|".join(
    re.escape(c) for c in sorted(_NATIVE_COUNTERS | _SINO_COUNTERS, key=len, reverse=True)
)
text = re.sub(rf'(\d+)\s*({all_counters})', _convert_number_with_counter, text)
text = re.sub(r'(\d+)\s*%', lambda m: _sino_number(int(m.group(1))) + " 퍼센트", text)
text = re.sub(r'\d+', _convert_standalone_number, text)
```

### 2. g2pk 관련 코드 정리 (important)

g2pk를 TTS 파이프라인에서 사용하지 않으므로, 관련 코드를 제거하거나 주석 처리한다.

**제거할 코드 블록들:**

```python
# 모듈 상단에서 제거:
_G2PK_AVAILABLE = False
_g2p_instance: object | None = None
try:
    import g2pk as _g2pk_module  # noqa: F401
    _G2PK_AVAILABLE = True
    logger.debug("g2pk 로드 완료")
except ImportError:
    pass

# _get_g2p 함수 전체 제거:
def _get_g2p() -> object:
    ...
```

### 3. requirements.txt에서 g2pk 제거 (important)

g2pk는 Mecab C 라이브러리 의존성이 있어 설치/배포 복잡도를 높이고, 현재 파이프라인에서 사용하지 않으므로 제거한다.

**변경 전:**
```
g2pk>=0.0.6
soynlp>=0.0.493
```

**변경 후:**
```
soynlp>=0.0.493
```

### 4. soynlp repeat_normalize 예외 안전성 추가 (minor)

soynlp가 설치되었지만 런타임에 실패할 경우를 대비한다.

**변경 전:**
```python
if _SOYNLP_AVAILABLE:
    text = _soynlp_repeat_normalize(text, num_repeats=1)
```

**변경 후:**
```python
if _SOYNLP_AVAILABLE:
    try:
        text = _soynlp_repeat_normalize(text, num_repeats=1)
    except Exception:
        logger.warning("soynlp repeat_normalize 실패, 건너뜀")
```

### 5. slang_map.json 끝에 newline 추가 (minor)

POSIX 호환을 위해 파일 끝에 newline을 추가한다.

```json
  "MBTI": "엠비티아이"
}
```
위 `}` 뒤에 빈 줄(newline) 1개 추가.

---

## 수정 후 기대 결과

각 입력이 다음 텍스트로 Fish Speech에 전달되어야 한다:

| 입력 | Fish Speech에 전달되는 텍스트 |
|---|---|
| 남친 집안 때문에 헤어져? | 남자친구 집안 때문에 헤어져? |
| 20대 후반 여자 남친과 5년 넘게 연애 중 | 이십 대 후반 여자 남자친구와 오 년 넘게 연애 중. |
| 명절 방문 이야기 듣고 부모님 반대 당함ㅋㅋ | 명절 방문 이야기 듣고 부모님 반대 당함. |
| 남친 가족 관계 너무 돈독해서 걱정됨 | 남자친구 가족 관계 너무 돈독해서 걱정됨. |
| 베댓 '올바른 결혼은 효자가 아니라' | 베스트 댓글 올바른 결혼은 효자가 아니라. |
| 여러분들의 생각은 어떤가요? | 여러분들의 생각은 어떤가요? |

핵심 확인 포인트: **모든 단어가 표준 한국어 맞춤법 형태**여야 한다. "지반", "여내", "겨로는", "댇끌" 등 발음형 텍스트가 절대 포함되면 안 된다.

---

## 수정 후 처리 순서 (최종)

```
0. 화자 접두어 제거
1. 인터넷 축약어 치환 (SLANG_MAP)
1-1. 조사 자동 교정
1-2. soynlp repeat_normalize (가용시, try/except 감싸기)
2. 자모 이모티콘 삭제
3. 숫자 → 한국어 변환 (built-in only, g2pk 사용 안 함)
4. 특수문자 정리
5. 문장 완성도 보정
```

---

## 변경 파일 목록

| 파일 | 변경 내용 |
|---|---|
| `ai_worker/tts_worker.py` | g2pk 분기 제거, built-in 숫자 변환만 사용, g2pk import/init 코드 제거, soynlp try/except 추가 |
| `requirements.txt` | `g2pk>=0.0.6` 행 삭제 |
| `assets/slang_map.json` | 파일 끝 newline 추가 |

---

## 금지 사항

- `g2pk`를 텍스트 전체에 적용하지 말 것. Fish Speech는 자체 G2P가 있으므로 **표준 맞춤법 텍스트**만 입력해야 한다.
- 향후 g2pk를 다시 도입하려면, **숫자 부분만 추출 → g2pk로 변환 → 원래 위치에 재삽입**하는 방식으로 격리해야 한다. 전체 텍스트에 적용하면 반드시 이중 G2P가 발생한다.
