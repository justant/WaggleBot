# 작업지시서: tts_worker.py 한국어 전처리 파이프라인 개선

## 배경

Fish Speech 1.5 기반 한국어 TTS에서 인터넷 커뮤니티 텍스트(축약어, 자모 이모티콘, 숫자 등)를 합성할 때 **중국어 폴백 발음**, **어색한 합성**, **프로소디 붕괴** 문제가 반복 발생 중이다. 현재 `tts_worker.py`의 `_normalize_for_tts()` 함수가 이를 충분히 처리하지 못하고 있다.

---

## 현재 문제점 (5가지)

### 1. 인터넷 축약어 미처리
"남친", "베댓", "킹받", "갑분싸" 등 비표준 축약어가 Fish Speech 토크나이저에 등록되지 않아 중국어 발음으로 폴백되거나 합성이 깨진다.

### 2. ㅋㅋ → 크크 변환이 역효과
현재 코드에서 `ㅋㅋ`을 `크크`로 치환하는데, "크크"는 실제 한국어 발화에 없는 표현이라 TTS 출력이 부자연스럽다. 자모 이모티콘은 삭제하는 것이 올바른 처리다.

### 3. 숫자 → 한국어 읽기 변환 부재
"20대", "5년", "30살" 등 숫자가 한국어로 변환되지 않고 그대로 전달되어 Fish Speech가 중국어식/영어식으로 읽을 수 있다. 한자어 수사("이십대")와 고유어 수사("다섯 살")를 단위에 따라 구분해야 한다.

### 4. 특수 따옴표/유니코드 문장부호
스마트 따옴표(`'`, `'`, `"`, `"`), 중국어 구두점(`。`, `、`), 꺾쇠 인용부호(`「」`, `『』`) 등이 토크나이저를 혼란시킨다.

### 5. 문장 완성도 부족
body 항목이 마침표 없는 짧은 구절로 들어오면 Fish Speech의 프로소디(운율) 예측이 불안정해진다. 문장 끝에 마침표를 보정해야 한다.

---

## 작업 범위

대상 파일: `tts_worker.py` 내 `_normalize_for_tts()` 함수 전면 교체

### 필수 구현 사항

#### A. 인터넷 축약어 사전 치환
- `SLANG_MAP` 딕셔너리를 모듈 상단에 정의한다.
- 최소 포함 항목:

```python
SLANG_MAP = {
    "남친": "남자친구",
    "여친": "여자친구",
    "베댓": "베스트 댓글",
    "갑분싸": "갑자기 분위기 싸해짐",
    "ㄹㅇ": "진짜",
    "ㅇㅇ": "응",
    "ㄴㄴ": "아니",
    "ㅇㅋ": "오케이",
    "ㄱㅅ": "감사",
    "ㅈㅅ": "죄송",
    "ㅂㅂ": "바이바이",
    "ㄷㄷ": "",
    "시모": "시어머니",
    "장모": "장모님",
    "솔까말": "솔직히 까놓고 말해서",
    "킹받": "화가 남",
    "억까": "억지로 까는",
    "TMI": "티엠아이",
    "MBTI": "엠비티아이",
}
```

- 긴 키워드부터 먼저 매칭해서 부분 매칭을 방지한다 (`sorted(... key=lambda x: -len(x[0]))`).
- 이 사전은 운영 중 쉽게 확장할 수 있도록 별도 파일이나 config로 분리하는 것을 고려한다.

#### B. 자모 이모티콘 완전 삭제
- 기존의 `ㅋㅋ → 크크`, `ㅎㅎ → 하하` 변환을 **제거**한다.
- 2개 이상 반복되는 자모(`ㅋㅋㅋ`, `ㅎㅎ`, `ㅠㅠ`, `ㅜㅜ` 등)는 빈 문자열로 치환한다.
- 변환되지 않은 나머지 단독 자모(`ㄱ`~`ㅎ`, `ㅏ`~`ㅣ`)도 모두 삭제한다.

```python
text = re.sub(r'[ㅋㅎㅠㅜㅡ]{2,}', '', text)
text = re.sub(r'[ㄱ-ㅎㅏ-ㅣ]+', '', text)
```

#### C. 숫자 → 한국어 읽기 변환
아래 규칙을 구현한다:

| 패턴 | 변환 방식 | 예시 |
|---|---|---|
| 숫자 + 고유어 단위 (살, 명, 개, 시, 잔, 번, 마리, 벌, 켤레) | 고유어 수사 | `3명` → `세 명`, `20살` → `스무 살` |
| 숫자 + 한자어 단위 (년, 월, 일, 원, 호, 층, 도, 분, 초, 대, 위, 회, 점) | 한자어 수사 | `5년` → `오 년`, `20대` → `이십 대` |
| 숫자 + `%` | 한자어 수사 + "퍼센트" | `30%` → `삼십 퍼센트` |
| 단독 숫자 | 한자어 수사 | `2024` → `이천이십사` |

한자어 수사 변환 함수는 4자리씩 끊어서 만/억/조 단위를 처리해야 한다.
고유어 수사는 1~99까지만 지원하고, 100 이상은 한자어로 폴백한다.

#### D. 조사 자동 교정
축약어 치환 후 받침이 변경되어 조사가 맞지 않는 경우를 교정한다.

- `남친과` → (축약어 치환) → `남자친구과` → (조사 교정) → `남자친구와`

교정 대상 조사 쌍:

| 받침 있을 때 | 받침 없을 때 |
|---|---|
| 과 | 와 |
| 은 | 는 |
| 이 | 가 |
| 을 | 를 |
| 으로 | 로 |
| 아 | 야 |

받침 유무 판별: `(ord(char) - 0xAC00) % 28 != 0`

#### E. 특수문자 정리
- 중국어/일본어 구두점: `。→.`, `、→,`
- 물결표: `~`, `～` → 공백
- 스마트 따옴표: `'`, `'`, `"`, `"` → 공백
- 기타 인용부호: `「」`, `『』`, `【】` → 공백
- 연속 공백 → 단일 공백으로 정리

#### F. 문장 완성도 보정
- 마침표(`.`, `!`, `?`)없이 끝나는 텍스트에 마침표를 자동 추가한다.
- 이를 통해 Fish Speech의 프로소디(억양/운율) 예측을 안정화한다.

---

### 처리 순서 (반드시 이 순서를 지킬 것)

```
1. 화자 접두어 제거  ("ㅇㅇ: ", "A: " 형태)
2. 인터넷 축약어 치환  (SLANG_MAP)
3. 조사 자동 교정     (받침 변경에 따른 조사 불일치 수정)
4. 자모 이모티콘 삭제  (ㅋㅋ, ㅎㅎ 등 → 빈 문자열)
5. 숫자 → 한국어 변환  (단위별 고유어/한자어 구분)
6. 특수문자 정리       (따옴표, 구두점, 물결표)
7. 문장 완성도 보정    (마침표 추가)
```

순서가 중요한 이유:
- 축약어 치환(2) 후에 조사 교정(3)을 해야 받침 변경을 반영할 수 있다.
- 자모 삭제(4)는 축약어 치환(2) 이후에 해야, `SLANG_MAP`에 등록된 자모 축약어(`ㄹㅇ`, `ㄱㅅ` 등)가 먼저 치환된 뒤 나머지만 삭제된다.

---

### 선택 구현 사항 (권장)

#### G. 외부 라이브러리 도입 검토

다음 라이브러리를 파이프라인에 통합하는 것을 검토한다:

**g2pK** (`pip install g2pk`)
- 한국어 발음 규칙을 Mecab 기반 문맥 분석으로 처리하는 G2P 라이브러리
- 숫자 읽기, 연음/경음화 등 표준 발음 변환 지원
- **주의**: Fish Speech 자체에 G2P가 있으므로, g2pK는 반드시 `to_syl=True` (기본값, 음절 단위 한글 출력)로만 사용할 것. `to_syl=False` (자모 분리)로 사용하면 이중 변환으로 품질이 오히려 저하된다.
- 도입 시 숫자 변환(C항)은 g2pK에 위임 가능

```python
from g2pk import G2p
g2p = G2p()
text = g2p(text)  # to_syl=True가 기본값
```

**soynlp** (`pip install soynlp`)
- `repeat_normalize` 함수로 반복 문자 정규화 (`ㅋㅋㅋㅋㅋ → ㅋㅋ`)
- 자모 삭제 전 단계에서 반복 횟수를 통일하는 용도

```python
from soynlp.normalizer import repeat_normalize
text = repeat_normalize(text, num_repeats=1)
```

#### H. SLANG_MAP 외부 파일 분리
축약어 사전을 JSON 또는 YAML 파일로 분리하여, 코드 배포 없이 사전만 업데이트할 수 있도록 한다.

```
assets/
  slang_map.json
```

---

## 검증 방법

### 테스트 케이스

아래 입력에 대해 정규화 결과를 확인한다:

| 입력 | 기대 출력 |
|---|---|
| `남친 집안 때문에 헤어져?` | `남자친구 집안 때문에 헤어져?` |
| `20대 후반 여자 남친과 5년 넘게 연애 중` | `이십 대 후반 여자 남자친구와 오 년 넘게 연애 중.` |
| `명절 방문 이야기 듣고 부모님 반대 당함ㅋㅋ` | `명절 방문 이야기 듣고 부모님 반대 당함.` |
| `베댓 '올바른 결혼은 효자가 아니라'` | `베스트 댓글 올바른 결혼은 효자가 아니라.` |
| `여러분들의 생각은 어떤가요?` | `여러분들의 생각은 어떤가요?` |

### TTS 출력 확인
- 정규화된 텍스트를 Fish Speech API에 전달한 후 생성된 오디오에서 **중국어 발음이 섞이지 않는지**, **숫자가 한국어로 읽히는지**, **문장 끝 억양이 자연스러운지** 확인한다.

---

## 참고 파일

- 현재 코드: `tts_worker.py` 
- 개선 참고 구현: `tts_normalize_improved.py` (arch/ 폴더에 첨부됨) — 위 사항이 모두 구현된 참조 코드. 이 파일의 `normalize_for_tts()` 함수와 관련 유틸리티를 `tts_worker.py`에 통합하면 된다.

---

## 작업 완료 기준

1. `_normalize_for_tts()` 함수가 위 A~F 사항을 모두 처리한다.
2. 위 테스트 케이스가 모두 기대 출력과 일치한다.
3. 기존 `synthesize()` 함수의 인터페이스(파라미터, 반환값)는 변경하지 않는다.
4. `config/settings.py`에 대한 import는 기존 그대로 유지한다.
5. 새로 추가되는 함수/상수는 모두 `tts_worker.py` 내부 또는 같은 패키지의 별도 모듈에 둔다.
