# 3. Figma 기반 렌더러 아키텍처 (Renderer from Figma)

> **문서 상태:** 완료 (Merged to Main)
> **적용 버전:** WaggleBot v2.0 (Legacy `ssul_renderer` 삭제됨)
> **관련 커밋:** `bb89776` ~ `c62dcda`

## 1. 개요 (Overview)

기존의 Python 하드코딩 방식 렌더러(`ssul_renderer.py`)를 폐기하고, 디자인 도구(Figma)의 실측 데이터를 JSON 설정 파일로 관리하는 **데이터 기반 렌더링 엔진(`layout_renderer.py`)**을 도입했습니다.

이 변화를 통해 개발자가 코드를 수정하지 않고도 `layout.json` 값만 변경하여 디자인(좌표, 폰트, 정렬, 색상)을 즉시 수정할 수 있게 되었습니다.

---

## 2. 핵심 아키텍처 (Core Architecture)

### 2.1 데이터 흐름 (Data Flow)
1.  **Design:** Figma에서 4가지 씬(Intro, Img+Text, TextOnly, Outro) 디자인 및 좌표 추출.
2.  **Config:** `config/layout.json`에 좌표(`x`, `y`), 스타일, 제약 조건(`max_chars`) 정의.
3.  **Rendering:** `ai_worker/layout_renderer.py`가 JSON을 로드하여 이미지 합성.

### 2.2 씬(Scene) 구성
쇼츠 영상은 다음 4가지 씬의 유기적인 조합으로 생성됩니다.

| 씬 타입 (Scene Type) | 역할 | 특징 |
| :--- | :--- | :--- |
| **Intro** | 제목 표시 | `base_layout.png`의 헤더 영역 사용 (Left Align) |
| **Img + Text** | 이미지 위주 본문 | 상단 이미지(Cover Fit) + 하단 텍스트(2줄) |
| **Text Only** | 텍스트 위주 본문 | 3개의 고정 슬롯(`y_coords`)에 순차적 텍스트 배치 |
| **Outro** | 마무리 | 남은 이미지 소진 + 오버레이 텍스트 |

### 2.3 스마트 씬 배분 알고리즘
입력된 스크립트 문장 수와 확보된 이미지 수의 비율(`ratio`)을 계산하여 최적의 레이아웃을 자동 선택합니다.
- `ratio >= 0.8`: **Image Heavy** (대부분의 문장에 이미지 배치)
- `ratio < 0.3`: **Text Heavy** (`Text Only` 모드 적극 활용, 3줄씩 끊어서 표시)

---

## 3. 주요 기술적 개선 사항 (Technical Improvements)

### 3.1 베이스 프레임 베이킹 (Base Frame Baking)
성능 최적화와 제목 흔들림 방지를 위해 **"배경 굽기"** 기술을 도입했습니다.
- **동작:** 렌더링 시작 시, `base_layout.png` 배경 위에 영상의 **제목(Title)과 헤더 정보**를 단 1회 합성하여 메모리에 캐싱합니다.
- **효과:** 모든 프레임이 이 베이스 이미지를 복사(`copy()`)하여 시작하므로, 장면이 전환되어도 제목 위치가 1픽셀도 어긋나지 않습니다.

### 3.2 텍스트 렌더링 엔진 고도화
- **픽셀 기반 래핑 (`_wrap_korean`):** 글자 수 기준이 아닌, 실제 폰트의 픽셀 폭(`font.getlength`)을 계산하여 정밀하게 줄바꿈합니다.
- **슬롯 시스템 (`y_coords`):** `Text Only` 모드에서 텍스트가 쌓이는 위치를 동적으로 계산하지 않고, `[550, 700, 850]`과 같이 고정 좌표 배열을 사용하여 디자인 안정성을 확보했습니다.
- **말줄임 (`Truncate`):** `layout.json`에 설정된 `max_chars`(예: 15자)를 초과하면 자동으로 `..` 처리를 수행하여 레이아웃 파괴를 방지합니다.
- **정렬 지원:** 기존 중앙 정렬 강제 로직을 개선하여, 설정에 따라 `Left`, `Center` 정렬을 모두 지원합니다. (제목은 `Left` 적용)

### 3.3 오디오 싱크 보정 (Audio Sync Correction)
TTS와 영상의 불일치를 해결하기 위해 오디오 파이프라인을 개선했습니다.
1.  **묵음 제거 (`Silenceremove`):** `FFmpeg` 필터를 사용하여 TTS 생성 시 앞부분의 미세한 묵음을 제거, 텍스트 출력과 동시에 소리가 나도록 합니다.
2.  **SFX 오프셋 (`SSUL_SFX_OFFSET`):** 효과음(팝, 찰칵 등)이 텍스트보다 약 `0.15초` 먼저 나오도록 설정하여 타격감을 개선했습니다.

---

## 4. 설정 파일 명세 (`layout.json`)

디자인 변경 시 코드가 아닌 아래 JSON 값을 수정합니다.

```json
{
  "global": {
    "header_title": {
      "x": 50, "y": 200,       // 제목 위치 (Left Align 기준)
      "font_size": 55,
      "align": "left",         // 정렬 방식
      "color": "#000000"       // 글자 색상
    }
  },
  "scenes": {
    "text_only": {
      "text_max_chars": 15,    // 말줄임 기준
      "elements": {
        "text_area": {
          "font_size": 60,     // 본문 폰트 크기
          "y_coords": [550, 700, 850], // 1~3번째 줄 고정 Y좌표
          "max_slots": 3
        }
      }
    }
  }
}